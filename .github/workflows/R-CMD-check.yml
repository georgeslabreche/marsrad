name: R-CMD-check

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  R-CMD-check:
    runs-on: ubuntu-latest
    env:
      NET_FLUX_FUNCTION_SHOW_WARNINGS: FALSE

    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: any::rcmdcheck, any::covr
          needs: check

      - name: Check package
        uses: r-lib/actions/check-r-package@v2

      - name: Test coverage
        run: |
          options(crayon.enabled = TRUE)
          library(covr)

          # Calculate coverage
          coverage <- package_coverage()
          print(coverage)
          percent_coverage <- percent_coverage(coverage)

          # Print to console
          cat(sprintf("\nOverall coverage: %.2f%%\n", percent_coverage))

          # Add to GitHub Actions job summary
          summary_file <- Sys.getenv("GITHUB_STEP_SUMMARY")
          cat("## Test Coverage Report\n\n", file = summary_file, append = TRUE)
          cat(sprintf("**Overall Coverage: %.2f%%**\n\n", percent_coverage), file = summary_file, append = TRUE)
          cat("### Coverage by File\n\n", file = summary_file, append = TRUE)
          cat("| File | Coverage |\n", file = summary_file, append = TRUE)
          cat("|------|----------|\n", file = summary_file, append = TRUE)

          # Get per-file coverage
          files <- unique(sapply(coverage, function(x) {
            src <- getSrcFilename(x, full.names = FALSE)
            if (is.null(src)) "" else as.character(src)
          }))
          files <- files[files != ""]
          files <- sort(files)
          for (file in files) {
            file_cov <- coverage[sapply(coverage, function(x) {
              src <- getSrcFilename(x, full.names = FALSE)
              !is.null(src) && as.character(src) == file
            })]
            if (length(file_cov) > 0) {
              cov_values <- sapply(file_cov, function(x) attr(x, "coverage"))
              file_percent <- sum(cov_values > 0) / length(cov_values) * 100
              cat(sprintf("| %s | %.2f%% |\n", file, file_percent), file = summary_file, append = TRUE)
            }
          }

          # Generate HTML report
          report_dir <- file.path(getwd(), "coverage-report")
          dir.create(report_dir, showWarnings = FALSE)
          covr::report(coverage, file = file.path(report_dir, "coverage.html"), browse = FALSE)
          cat(sprintf("\nHTML coverage report generated in %s\n", report_dir))
        shell: Rscript {0}

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage-report/

      - name: Show test failures
        if: failure()
        run: |
          find . -name 'testthat.Rout.fail' -exec cat '{}' \; || true
        shell: bash
